rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isSignedIn() {
        return request.auth != null;
    }

    function currentUserPath() {
      return /databases/$(database)/documents/users/$(request.auth.uid);
    }

    function hasCurrentUserDoc() {
      return isSignedIn() && exists(currentUserPath());
    }

    function currentUserRole() {
      return hasCurrentUserDoc() ? get(currentUserPath()).data.role : null;
    }

    function currentUserInstitutionId() {
      return hasCurrentUserDoc() ? get(currentUserPath()).data.institutionId : null;
    }

    function isGlobalAdmin() {
      return currentUserRole() == 'admin';
    }

    function isInstitutionAdmin() {
      return currentUserRole() == 'schooladmin';
    }

    function canManageInstitution(institutionId) {
      return isGlobalAdmin()
        || (
          isInstitutionAdmin()
          && currentUserInstitutionId() != null
          && institutionId == currentUserInstitutionId()
        );
    }
    
    function isOwner() {
        return resource.data.ownerId == request.auth.uid || resource.data.userId == request.auth.uid;
    }
    
    function isShared() {
      // verify the field exists and the user's UID is inside it
      return request.auth.uid in resource.data.sharedWithUids;
    }

    function validShortcutCreatePayload() {
      return request.resource.data.keys().hasAll([
        'ownerId',
        'parentId',
        'targetId',
        'targetType',
        'institutionId',
        'createdAt'
      ])
      && (request.resource.data.targetType == 'subject' || request.resource.data.targetType == 'folder');
    }

    function isTargetOwnerForCreate() {
      return (
        request.resource.data.targetType == 'subject'
        && exists(/databases/$(database)/documents/subjects/$(request.resource.data.targetId))
        && (
          get(/databases/$(database)/documents/subjects/$(request.resource.data.targetId)).data.ownerId == request.auth.uid
          || get(/databases/$(database)/documents/subjects/$(request.resource.data.targetId)).data.uid == request.auth.uid
        )
      )
      || (
        request.resource.data.targetType == 'folder'
        && exists(/databases/$(database)/documents/folders/$(request.resource.data.targetId))
        && (
          get(/databases/$(database)/documents/folders/$(request.resource.data.targetId)).data.ownerId == request.auth.uid
          || get(/databases/$(database)/documents/folders/$(request.resource.data.targetId)).data.uid == request.auth.uid
        )
      );
    }

    function targetSharedWithShortcutOwner() {
      return (
        request.resource.data.targetType == 'subject'
        && exists(/databases/$(database)/documents/subjects/$(request.resource.data.targetId))
        && (
          request.resource.data.ownerId in get(/databases/$(database)/documents/subjects/$(request.resource.data.targetId)).data.sharedWithUids
        )
      )
      || (
        request.resource.data.targetType == 'folder'
        && exists(/databases/$(database)/documents/folders/$(request.resource.data.targetId))
        && (
          request.resource.data.ownerId in get(/databases/$(database)/documents/folders/$(request.resource.data.targetId)).data.sharedWithUids
        )
      );
    }
    
    // Reglas para usuarios
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == userId;
    }

    // Reglas principales de Asignaturas
    match /subjects/{subjectId} {
      // Permite leer/escribir si estás autenticado (puedes hacerlo más estricto si quieres)
      allow read, write: if isSignedIn();

      // Reglas para la subcolección "topics"
      match /topics/{topicId} {
        allow read, write: if isSignedIn();

        // 1. Pestaña "Generados por IA" (FALTABA ESTO)
        match /resumen/{docId} {
          allow read, write: if isSignedIn();
        }

        // 2. Pestaña "Mis Archivos" (FALTABA ESTO)
        match /materials/{docId} {
          allow read, write: if isSignedIn();
        }

        // 3. Tests y Resultados (Ya los tenías)
        match /quizzes/{quizId} {
          allow read, write: if isSignedIn();
        }
        match /quiz_results/{resultId} {
          allow read, write: if isSignedIn();
        }
        match /documents/{docId} {
          allow read, write: if isSignedIn();
        }
      }
    }
    
    // Reglas para Carpetas (Folders)
    match /folders/{folderId} {
      allow create: if isSignedIn();
      allow read, write: if isSignedIn();
    }

    match /schools/{schoolId} {
      allow read: if isSignedIn();
      allow create: if isGlobalAdmin();
      allow update: if canManageInstitution(resource.data.institutionId)
        && request.resource.data.institutionId == resource.data.institutionId;
      allow delete: if isGlobalAdmin();
    }

    match /institutions/{institutionId} {
      allow read: if isSignedIn();
      allow create: if isGlobalAdmin();
      allow update: if canManageInstitution(resource.data.institutionId)
        && request.resource.data.institutionId == resource.data.institutionId;
      allow delete: if isGlobalAdmin();
    }

    // Reglas para Shortcuts (en la raíz)
    match /shortcuts/{shortcutId} {
      // Owner can create own shortcut OR target owner can create shortcut for a shared recipient (share flow)
      allow create: if isSignedIn()
        || validShortcutCreatePayload()
        && (
          request.resource.data.ownerId == request.auth.uid
          || (
            request.resource.data.ownerId != request.auth.uid
            && isTargetOwnerForCreate()
            && targetSharedWithShortcutOwner()
          )
        );
      // Allow read if the user is the shortcut owner OR the owner of the subject referenced by the shortcut
      allow read: if isSignedIn() && (
        resource.data.ownerId == request.auth.uid
        || (
          resource.data.targetType == 'subject'
          && exists(/databases/$(database)/documents/subjects/$(resource.data.targetId))
          && (
            get(/databases/$(database)/documents/subjects/$(resource.data.targetId)).data.ownerId == request.auth.uid
            || get(/databases/$(database)/documents/subjects/$(resource.data.targetId)).data.uid == request.auth.uid
          )
        )
        || (
          resource.data.targetType == 'folder'
          && exists(/databases/$(database)/documents/folders/$(resource.data.targetId))
          && (
            get(/databases/$(database)/documents/folders/$(resource.data.targetId)).data.ownerId == request.auth.uid
            || get(/databases/$(database)/documents/folders/$(resource.data.targetId)).data.uid == request.auth.uid
          )
        )
      );
      allow delete, update: if isSignedIn() && resource.data.ownerId == request.auth.uid;
      // (Opcional) Para multi-tenant: && resource.data.institutionId == request.auth.token.institutionId
    }
  }
}