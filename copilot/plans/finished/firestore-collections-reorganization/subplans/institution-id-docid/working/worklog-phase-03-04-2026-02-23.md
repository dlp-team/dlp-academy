# Worklog - Phase 03/04 (2026-02-23)

## Summary
- Phase 03 reads/filter alignment advanced by cleaning remaining legacy school references in docs.
- Phase 04 legacy migration planning started.

## Changes
- Updated ReadmePannels to replace schoolId/schooladmin/schools with institutionId/institutionadmin/institutions.
- Added Phase 04 legacy migration plan file.
- Tightened Firestore rules to enforce institution scoping across key collections.
- Added migration script for backfilling institutionId on legacy data.

## Files Touched
- src/pages/ReadmePannels.md
- copilot/plans/firestore-collections-reorganization/subplans/institution-id-docid/phases/phase-04-legacy-migration-in-progress.md
- firestore.rules
- scripts/backfill-institution-id.js

## Next Actions
- Run migration script in staging, then production.
- Verify rules with staging smoke tests.

## Delta Log - 2026-02-23 (Root collections for topics/documents/quizzes)

### Scope
- Verified and refactored active app flows so `topics`, `documents`, and `quizzes` are read/written from root collections (no nested `subjects/{subjectId}/topics/...` for these three entities).

### Implemented
- `useSubjects`: topic loading changed to `topics` root with `where(subject_id == subject.id)`.
- `useSubjectManager`: topic CRUD + reorder moved to root `topics`; initial file entries moved to root `documents`; relation fields stamped (`subject_id`, `topic_id`) and owner/institution fallbacks added.
- `SubjectTopicModal`: topic list/reorder moved to root `topics`.
- `useTopicLogic`: topic/documents/quizzes listeners and CRUD moved to root collections.
- `Quizzes` (`Quizzes.jsx`, `useQuizzesLogic.js`, `QuizEdit.jsx`): topic/quiz reads and quiz updates moved to root `topics`/`quizzes`.
- `useUserStatistics`: topic traversal moved to root `topics` by `subject_id`.
- `StudyGuideEditor`: topic permission read moved to root `topics`.

### Verification Log
- Targeted search confirms no active nested access remains for:
	- `subjects/{subjectId}/topics/{topicId}/documents/*`
	- `subjects/{subjectId}/topics/{topicId}/quizzes/*`
	- topic CRUD/read via `subjects/{subjectId}/topics/*`
- Existing nested usage intentionally left in other feature collections (`quiz_results`, `materials`, `resumen`) and archive files.

### Notes
- This change assumes migrated root docs include relationship fields: `subject_id` and `topic_id`.
- Root writes now preserve tenant/ownership metadata through `institutionId`/`ownerId` fallbacks where flows create documents.
